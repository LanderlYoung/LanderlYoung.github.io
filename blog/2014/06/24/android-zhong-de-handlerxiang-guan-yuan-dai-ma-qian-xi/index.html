
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Android 中的Handler相关源代码浅析 - Young_Blog</title>
	<meta name="author" content="LanderlYoung">

	
	<meta name="description" content="Android 中的Handler相关源代码浅析 简单用法示例： 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
//在主线程中
private Handler handler = new Handler() { // 处理子线程给我们发送的消息。 @Override &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Young_Blog" type="application/atom+xml">
	
	<link rel="canonical" href="http://LanderlYoung.github.io/blog/2014/06/24/android-zhong-de-handlerxiang-guan-yuan-dai-ma-qian-xi/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  
  <script src="/javascripts/libs/jquery.min.js"></script>

	
</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">	
	 
	<img src="/images/profile.png" width=160px />
</div>
<h1><a href="/">Young_Blog</a></h1>
<p class="subtitle">Life with Passion<br/>Code with Creativity</p>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about-me/">About Me</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		<a class="weibo" href="http://www.weibo.com/1863369094" title="Weibo">Weibo</a>
		
		
		
		<a class="google" href="https://plus.google.com/101237485378321820376/posts" rel="author" title="Google+">Google+</a>
		
		
		
		<a class="github" href="https://github.com/LanderlYoung" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>

</header>				
			</div>
		</div>	
		<div class="mid-col">
			
			
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Android 中的Handler相关源代码浅析</h1>
	<div class="entry-content" itemprop="articleBody"><p>简单用法示例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//在主线程中</span>
</span><span class='line'><span class="kd">private</span> <span class="n">Handler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// 处理子线程给我们发送的消息。</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span><span class="n">msg</span><span class="o">.</span><span class="na">obj</span><span class="o">;</span>
</span><span class='line'>            <span class="n">Bitmap</span> <span class="n">bitmap</span> <span class="o">=</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeByteArray</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span><span class='line'>            <span class="n">imageView</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">);</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;handler&quot;</span><span class="o">,</span> <span class="s">&quot;thread:&quot;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>                    <span class="s">&quot; msg.target=&quot;</span> <span class="n">msg</span><span class="o">.</span><span class="na">getTarget</span><span class="o">());</span>
</span><span class='line'>            <span class="k">if</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">==</span> <span class="n">DOWNLOAD_IMG</span><span class="o">){</span>
</span><span class='line'>                <span class="n">dialog</span><span class="o">.</span><span class="na">dismiss</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后开启新的线程，在新的线程里面完成后台任务，任务完成后给这个handler发一个消息让它来处理。因为Handler是在主线程实例化(并且在实例化的时候没有指明Looper)，因此handler的handleMessage方法也是在主线程被调用的。</p>

<p>使用Handler Message MessageQueue Looper等方式去访问网络资源的时候，我们必须要开启一个子线程</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyThread</span> <span class="kd">implements</span> <span class="n">Runnable</span><span class="o">{</span>
</span><span class='line'>    <span class="c1">// 在run方法中完成网络耗时的操作</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">HttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultHttpClient</span><span class="o">();</span>
</span><span class='line'>            <span class="n">HttpGet</span> <span class="n">httpGet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpGet</span><span class="o">(</span><span class="n">imgPath</span><span class="o">);</span>
</span><span class='line'>            <span class="n">HttpResponse</span> <span class="n">httpResponse</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;debug&quot;</span><span class="o">,</span> <span class="s">&quot;start download picture in thread:&quot;</span> <span class="o">+</span>
</span><span class='line'>                        <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>                <span class="n">httpResponse</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">httpGet</span><span class="o">);</span>
</span><span class='line'>                <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">&quot;debug&quot;</span><span class="o">,</span> <span class="s">&quot;download complete with status code&quot;</span> <span class="o">+</span>
</span><span class='line'>                        <span class="n">httpResponse</span><span class="o">.</span><span class="na">getStatusLine</span><span class="o">().</span><span class="na">getStatusCode</span><span class="o">());</span>
</span><span class='line'>                <span class="k">if</span><span class="o">(</span><span class="mi">200</span> <span class="o">==</span> <span class="n">httpResponse</span><span class="o">.</span><span class="na">getStatusLine</span><span class="o">().</span><span class="na">getStatusCode</span><span class="o">()){</span>
</span><span class='line'>                    <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">EntityUtils</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(</span><span class="n">httpResponse</span><span class="o">.</span><span class="na">getEntity</span><span class="o">());</span>
</span><span class='line'>                    <span class="c1">// 这里的数据data我们必须发送给UI的主线程，所以我们通过Message的方式来做桥梁。</span>
</span><span class='line'>                    <span class="n">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">();</span>
</span><span class='line'>                    <span class="n">message</span><span class="o">.</span><span class="na">obj</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
</span><span class='line'>                    <span class="n">message</span><span class="o">.</span><span class="na">what</span> <span class="o">=</span> <span class="n">DOWNLOAD_IMG</span><span class="o">;</span>
</span><span class='line'>                    <span class="n">handler</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// TODO: handle exception</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>分析一下整个过程的大致流程,首先从Handler的sendMessage下手：从源代码中看，sendMessage最终会调用到Handler中的sendMessageAtTime。</p>

<pre><code>```
</code></pre>

<p>public boolean sendMessageAtTime(Message msg, long uptimeMillis)
{</p>

<pre><code>boolean sent = false;
MessageQueue queue = mQueue;
if (queue != null) {
    //注意这两句
    msg.target = this;
    sent = queue.enqueueMessage(msg, uptimeMillis);
}
else {
    RuntimeException e = new RuntimeException(
            this + " sendMessageAtTime() called with no mQueue");
    Log.w("Looper", e.getMessage(), e);
}
return sent;
</code></pre>

<p>}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">看得出来主要做的事情就是把消息的</span><span class="n">target</span><span class="err">设置成自己，然后把消息存入到消息队列</span><span class="n">MessageQueue</span><span class="err">中去，</span>
</span><span class='line'><span class="err">接着首先去看看</span><span class="n">Handler</span> <span class="err">中的</span><span class="n">MessageQueue</span> <span class="n">mQueue</span><span class="err">的定义</span><span class="o">:</span>
</span></code></pre></td></tr></table></div></figure>


<p> java
&hellip;
final MessageQueue mQueue;
final Looper mLooper;
&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">定义在</span><span class="n">Handler</span><span class="err">类的最后，既然是</span><span class="kd">final</span><span class="err">的那初始化一定在构造函数了：</span>
</span><span class='line'>
</span><span class='line'><span class="err">默认构造函数，代码中的注释写道`默认构造函数把这个</span><span class="n">handler</span><span class="err">和当前线程的消息队列联系起来，如果没有（当前线程的消息队列），这个</span><span class="n">handler</span><span class="err">就不能接收消息了。`</span>
</span></code></pre></td></tr></table></div></figure>


<p>/<em>*
 * Default constructor associates this handler with the queue for the
 * current thread.
 *
 * If there isn&rsquo;t one, this handler won&rsquo;t be able to receive messages.
 </em>/
public Handler() {</p>

<pre><code>...
    mLooper = Looper.myLooper();
if (mLooper == null) {
    throw new RuntimeException(
            "Can't create handler inside thread that has not called Looper.prepare()");
}
mQueue = mLooper.mQueue;
mCallback = null;
</code></pre>

<p>}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">当然也可以通过含参构造函数提供消息队列，而不是使用默认的。</span>
</span></code></pre></td></tr></table></div></figure>


<p> java
/<em>*
 * Use the provided queue instead of the default one.
 </em>/
public Handler(Looper looper) {</p>

<pre><code>mLooper = looper;
mQueue = looper.mQueue;
mCallback = null;
</code></pre>

<p>}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">从上面两个函数可以看出来消息队列是</span><span class="n">Looper</span><span class="err">的一个成员变量，</span><span class="n">handler</span><span class="err">的</span><span class="n">sendMessage</span><span class="err">方法只是把</span><span class="n">Message</span><span class="err">加到了消息队列去。接着去看看</span><span class="n">Looper</span><span class="err">对消息队列</span><span class="n">mQueue</span><span class="err">做了什么。</span>
</span><span class='line'>
</span><span class='line'><span class="n">Looper</span><span class="err">中的</span><span class="n">MessageQueue</span><span class="err">的定义如下：</span>
</span></code></pre></td></tr></table></div></figure>


<p> java
&hellip;
&hellip;
final MessageQueue mQueue;
final Thread mThread;
&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">然后看到了</span><span class="n">Looper</span> <span class="err">中的</span><span class="n">loop</span><span class="err">方法</span>
</span></code></pre></td></tr></table></div></figure>


<p> java
/<em>*
 * Run the message queue in this thread. Be sure to call
 * {@link #quit()} to end the loop.
 </em>/
public static void loop() {</p>

<pre><code>final Looper me = myLooper();
if (me == null) {
    throw new RuntimeException("No Looper; Looper.prepare() wasn't called on this thread.");
}
final MessageQueue queue = me.mQueue;

// Make sure the identity of this thread is that of the local process,
// and keep track of what that identity token actually is.
Binder.clearCallingIdentity();
final long ident = Binder.clearCallingIdentity();

for (;;) {
    Message msg = queue.next(); // might block
    if (msg == null) {
        // No message indicates that the message queue is quitting.
        return;
    }

    // This must be in a local variable, in case a UI event sets the logger
    Printer logging = me.mLogging;
    if (logging != null) {
        logging.println("&gt;&gt;&gt;&gt;&gt; Dispatching to " + msg.target + " " +
                msg.callback + ": " + msg.what);
    }

    //注意这一句
    msg.target.dispatchMessage(msg);

    if (logging != null) {
        logging.println("&lt;&lt;&lt;&lt;&lt; Finished to " + msg.target + " " + msg.callback);
    }

    // Make sure that during the course of dispatching the
    // identity of the thread wasn't corrupted.
    final long newIdent = Binder.clearCallingIdentity();
    if (ident != newIdent) {
        Log.wtf(TAG, "Thread identity changed from 0x"
                + Long.toHexString(ident) + " to 0x"
                + Long.toHexString(newIdent) + " while dispatching to "
                + msg.target.getClass().getName() + " "
                + msg.callback + " what=" + msg.what);
    }

    msg.recycle();
}
</code></pre>

<p>}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">注意到中间的死循环</span> <span class="err">`</span><span class="k">for</span><span class="o">(;;;){...}</span><span class="err">`</span>
</span><span class='line'><span class="err">以及关键的这一句：</span>
</span><span class='line'><span class="err">`</span><span class="n">msg</span><span class="o">.</span><span class="na">target</span><span class="o">.</span><span class="na">dispatchMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span><span class="err">`</span>
</span><span class='line'><span class="err">猜测</span><span class="n">target</span><span class="err">就是这个</span><span class="n">message</span><span class="err">对应处理他的</span><span class="n">handler</span><span class="err">，于是我圆润的滚过去看看：</span>
</span><span class='line'><span class="o">**</span><span class="n">Message</span><span class="o">**</span><span class="err">中的</span><span class="n">target</span><span class="err">是这么定义的：</span>
</span></code></pre></td></tr></table></div></figure>


<p> java
&hellip;
Handler target;
&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">看来八九不离十了。继续看</span><span class="n">target</span><span class="err">赋值的语句：</span>
</span></code></pre></td></tr></table></div></figure>


<p> java
public void setTarget(Handler target) {</p>

<pre><code>this.target = target;
</code></pre>

<p>}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">当然还有各种带有</span><span class="n">Handler</span><span class="err">参数的</span><span class="n">obtain</span><span class="err">方法，都会给</span><span class="n">target</span><span class="err">赋值。</span>
</span><span class='line'><span class="err">于是看看</span><span class="n">Handler</span><span class="o">.</span><span class="na">dispatchMessage</span><span class="o">(</span><span class="n">Message</span><span class="o">)</span><span class="err">是做什么的：</span>
</span></code></pre></td></tr></table></div></figure>


<p> java
public void dispatchMessage(Message msg) {</p>

<pre><code>if (msg.callback != null) {
    handleCallback(msg);
} else {
    if (mCallback != null) {
        if (mCallback.handleMessage(msg)) {
            return;
        }
    }
    handleMessage(msg);
}
</code></pre>

<p>}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">如果</span><span class="n">msg</span><span class="err">的</span><span class="n">callback</span><span class="err">不为</span><span class="kc">null</span><span class="err">就调用</span><span class="n">callback</span><span class="err">，否则就看看</span><span class="n">Handler</span> <span class="err">的</span><span class="n">mCallback</span><span class="err">有没有设置，如果有的话就让</span><span class="n">mCallback</span><span class="err">来处理消息，如果没有就是用默认的处理方法</span><span class="n">handleMessage</span><span class="err">。默认的处理方法是什么都不多，但是子类如果覆盖了</span><span class="n">handleMessage</span><span class="err">方法就可以执行子类想要做的代码了。</span>
</span><span class='line'>
</span><span class='line'><span class="err">所以整理一下流程是这样的：</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span><span class="o">.</span> <span class="err">实例化一个</span><span class="n">Handler</span><span class="err">或</span><span class="n">Handler</span><span class="err">的子类，可以在</span><span class="n">Looper</span><span class="err">参数内传入需要处理消息的那个线程对应的</span><span class="n">looper</span><span class="err">，如果没有传入就会使用当前线程默认的</span><span class="n">looper</span><span class="o">(</span><span class="err">如果有的话，否则</span><span class="n">handler</span><span class="err">会无法收到消息</span><span class="o">)</span><span class="err">。</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2</span><span class="o">.</span> <span class="err">在另一个线程中处理事物，完成之后构造一个存储结果的</span><span class="n">Message</span><span class="err">，使用</span><span class="n">handler</span><span class="err">发送构造的</span><span class="n">Message</span><span class="err">。</span><span class="n">handler</span><span class="err">发送</span><span class="n">Message</span><span class="err">的时候会把</span><span class="n">Message</span><span class="err">的</span><span class="n">target</span><span class="err">属性设置成他自己，这样</span><span class="n">looper</span><span class="err">在处理到这个消息的时候就能调用这个</span><span class="n">handler</span><span class="err">来处理这个</span><span class="n">message</span><span class="err">。</span>
</span><span class='line'>
</span><span class='line'><span class="mi">3</span><span class="o">.</span> <span class="n">handler</span><span class="err">发送完消息之后</span><span class="n">message</span><span class="err">就进入了</span><span class="n">looper</span><span class="err">的消息队列，然后</span><span class="n">looper</span><span class="err">会处理该消息队列。当取到了刚才发送的</span><span class="n">message</span><span class="err">的时候，</span><span class="n">looper</span><span class="err">就会调用该</span><span class="n">message</span><span class="err">指定的处理他的</span><span class="n">Handler</span><span class="err">（</span><span class="n">target</span><span class="err">）来处理这个消息。</span>
</span><span class='line'>
</span><span class='line'><span class="err">##说明##</span>
</span><span class='line'><span class="err">因为消息处理的回调是在</span><span class="n">Looper</span><span class="err">里面调用的，因此处理消息的线程就是</span><span class="n">looper</span><span class="err">所在的那个线程。不一定就是实例化</span><span class="n">Handerl</span><span class="err">时所在的线程，因为</span><span class="n">Handler</span> <span class="err">可以指定</span><span class="n">Looper</span><span class="err">。只有</span><span class="n">Handler</span><span class="err">没有指定</span><span class="n">Looper</span><span class="err">的情况下消息处理线程才是</span><span class="n">handler</span><span class="err">所在的那个线程，因为此时</span><span class="n">handler</span><span class="err">的默认</span><span class="n">looper</span><span class="err">就是</span><span class="n">handler</span><span class="err">所在的线程对应的</span><span class="n">looper</span><span class="err">。</span>
</span><span class='line'>
</span><span class='line'><span class="err">#附录</span>
</span><span class='line'><span class="err">最后说说###</span><span class="n">Message</span><span class="err">中的回收机制###</span>
</span><span class='line'><span class="err">因为</span><span class="n">Message</span><span class="err">是用来传输信息的经常会重复利用，所以维护一个</span><span class="n">Message</span> <span class="n">pool</span><span class="err">减少每次</span><span class="k">new</span><span class="err">的开销。源代码中是这么做的：</span>
</span><span class='line'><span class="err">首先是</span><span class="n">obtain</span><span class="err">方法</span>
</span></code></pre></td></tr></table></div></figure>


<p> java</p>

<p>/<em>*
 * Return a new Message instance from the global pool. Allows us to
 * avoid allocating new objects in many cases.
 </em>/
public static Message obtain() {</p>

<pre><code>synchronized (sPoolSync) {
    if (sPool != null) {
        Message m = sPool;
        sPool = m.next;
        m.next = null;
        sPoolSize--;
        return m;
    }
}
return new Message();
</code></pre>

<p>}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">如果池中有的话就取最后一个出来，如果没有就</span><span class="k">new</span><span class="err">一个。可以看到这些</span><span class="n">Message</span><span class="err">在</span><span class="n">pool</span><span class="err">是以单链表的形式组织的。</span>
</span><span class='line'><span class="err">然后看一下回收：</span>
</span></code></pre></td></tr></table></div></figure>


<p> java</p>

<p>/<em>*
 * Return a Message instance to the global pool.  You MUST NOT touch
 * the Message after calling this function &mdash; it has effectively been
 * freed.
 </em>/
public void recycle() {</p>

<pre><code>clearForRecycle();

synchronized (sPoolSync) {
    if (sPoolSize &lt; MAX_POOL_SIZE) {
        next = sPool;
        sPool = this;
        sPoolSize++;
    }
}
</code></pre>

<p>}</p>

<p>/<em>package</em>/ void clearForRecycle() {</p>

<pre><code>flags = 0;
what = 0;
arg1 = 0;
arg2 = 0;
obj = null;
replyTo = null;
when = 0;
target = null;
callback = null;
data = null;
</code></pre>

<p>}</p>

<p>&#8220;`
可以看到回收的时候先清空成员变量，然后把这个message加到pool这个单向链表的最前面，并更新链表头为当前message。如果pool已经满了就直接丢弃这个message等待垃圾回收。</p>
</div>

</article>

	

<!--aThis Button BEGIN -->
<div class="jiathis_style">
	<span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tools_1"></a>
	<a class="jiathis_button_tools_2"></a>
	<a class="jiathis_button_tools_3"></a>
	<a class="jiathis_button_tools_4"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner">
<p>
  Copyright &copy; 2014 - LanderlYoung -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>

<!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'landerlyoung';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://LanderlYoung.github.io/blog/2014/06/24/android-zhong-de-handlerxiang-guan-yuan-dai-ma-qian-xi/';
        var disqus_url = 'http://LanderlYoung.github.io/blog/2014/06/24/android-zhong-de-handlerxiang-guan-yuan-dai-ma-qian-xi/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







		</div>
	</div>

	<div id="slide">
		<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/06/24/android-zhong-de-handlerxiang-guan-yuan-dai-ma-qian-xi/">Android 中的Handler相关源代码浅析</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/20/sngmi-ni-xiang-mu-gan-wu/">SNG迷你项目感悟</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/27/cssdong-hua-lian-jie-te-xiao/">Css动画链接特效</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/26/wang-ye-zhong-shi-xian-yue-du-mo-shi/">网页中实现阅读模式</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/13/stepbystepandroid-di-%5B%3F%5D-ke/">stepByStepAndroid-第一课</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/android/'>android (3)</a></li><li><a href='/blog/categories/git/'>git (2)</a></li><li><a href='/blog/categories/html5/'>html5 (5)</a></li><li><a href='/blog/categories/javascript/'>javascript (3)</a></li><li><a href='/blog/categories/linux/'>linux (6)</a></li></ul>
</section>
<section>
	<h1>Tags</h1>
	<ul class="tag-cloud">
		<li><a style="font-size: 109.0%" href="/tags/android/">Android</a></li>
<li><a style="font-size: 99.5%" href="/tags/linux/">Linux</a></li>
<li><a style="font-size: 100.1%" href="/tags/html5/">HTML5</a></li>
<li><a style="font-size: 74.7%" href="/tags/dictonary-node-dot-js/">dictonary_Node.js</a></li>
<li><a style="font-size: 80.7%" href="/tags/node-dot-js/">Node.js</a></li>
<li><a style="font-size: 118.9%" href="/tags/git/">Git</a></li>
<li><a style="font-size: 111.4%" href="/tags/vim/">Vim</a></li>
<li><a style="font-size: 119.2%" href="/tags/svg/">SVG</a></li>
<li><a style="font-size: 117.1%" href="/tags/ui/">UI</a></li>
<li><a style="font-size: 94.3%" href="/tags/sou-gou-shu-ru-fa/">搜狗输入法</a></li>
<li><a style="font-size: 84.6%" href="/tags/zhuan-tie/">转贴</a></li>
<li><a style="font-size: 73.2%" href="/tags/octpressban-qian-bian-ji-wei-zhi/">Octpress搬迁编辑位置</a></li>
<li><a style="font-size: 81.5%" href="/tags/java/">Java</a></li>
<li><a style="font-size: 100.0%" href="/tags/tencent/">tencent</a></li>
<li><a style="font-size: 85.2%" href="/tags/androidyuan-dai-ma/">Android源代码</a></li>

	</ul>
</section>

	</div>
	<div id="hint">&gt;</div>

	<div id="drawer">
		<div id="touch"></div>
		<div id="bar">
			<div class="info">
				<ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about-me/">About Me</a></li>
</ul>

			</div>
		</div>
	</div>
	<script src="/javascripts/slide.js"></script>

</body>
</html>
