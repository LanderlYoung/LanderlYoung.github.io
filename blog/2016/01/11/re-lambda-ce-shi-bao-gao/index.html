
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>retro-lambda 测试报告 - Young_Blog</title>
	<meta name="author" content="LanderlYoung">

	
	<meta name="description" content="Retro-lambda 测试报告 retrolambda测试报告 先说结论 堆栈行号完全匹配！没有任何问题，包括最新的android build tools自身支持的switch string，MultiCatch，和retrolambda的所有特性都没问题。 &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Young_Blog" type="application/atom+xml">
	
	<link rel="canonical" href="http://LanderlYoung.github.io/blog/2016/01/11/re-lambda-ce-shi-bao-gao/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  
  <script src="/javascripts/libs/jquery.min.js"></script>

	
</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">	
	 
	<img src="/images/profile.png" width=160px />
</div>
<h1><a href="/">Young_Blog</a></h1>
<p class="subtitle">Life with Passion<br/>Code with Creativity</p>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about-me/">About Me</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		<a class="weibo" href="http://www.weibo.com/1863369094" title="Weibo">Weibo</a>
		
		
		
		<a class="google" href="https://plus.google.com/101237485378321820376/posts" rel="author" title="Google+">Google+</a>
		
		
		
		<a class="github" href="https://github.com/LanderlYoung" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>

</header>				
			</div>
		</div>	
		<div class="mid-col">
			
			
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Retro-lambda 测试报告</h1>
	<div class="entry-content" itemprop="articleBody"><h1>retrolambda测试报告</h1>

<p>先说结论</p>

<ol>
<li>堆栈行号完全匹配！没有任何问题，包括最新的android build tools自身支持的switch string，MultiCatch，和retrolambda的所有特性都没问题。</li>
<li>lambda是通过生成class来实现的，而且是生成static class而不是anonumous class，因此没有this$0引用。且支持<strong><a href="https://docs.oracle.com/javase/tutorial/java/javaOO/methodreferences.html">method reference （推荐阅读）</a></strong>。</li>
<li>但是lambda会生成冗余方法，每个Lambda类4个方法（下面有代码），其中一个是原接口的方法；增加3个，一个是构造方法，两个是静态工厂方法。</li>
<li>支持MultiCatch。</li>
<li>支持interface加default方法，亲测可行，但是使用该特性必须禁用增量编译。</li>
<li>支持interface加static方法，亲测不可行（可能版本bug），同上需要禁用增量编译。</li>
<li>支持tryWithResource但是估计这个用的不多，问题在于默认会吞掉Exception。同时Android Studio会报错说API19才能用，但是可以编译。</li>
<li>不支持Java8的新增API，包括Lambda相关的function包，和其他新包比如stream api。</li>
</ol>


<!--more-->


<p>下面是测试细节以及源代码和反编译代码对比：</p>

<h2>switch string（这个是java7自身的语法糖）</h2>

<p>源代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">switchWithString</span><span class="p">(</span><span class="n">String</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;switchWithString&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="s">&quot;hello&quot;</span><span class="o">:</span>
</span><span class='line'>            <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="s">&quot;World&quot;</span><span class="o">:</span>
</span><span class='line'>        <span class="k">case</span> <span class="s">&quot;world&quot;</span><span class="o">:</span>
</span><span class='line'>            <span class="k">new</span> <span class="n">Throwable</span><span class="p">().</span><span class="n">printStackTrace</span><span class="p">();</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>class反编译：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">switchWithString</span><span class="p">(</span><span class="n">String</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;switchWithString&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">byte</span> <span class="n">var2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">switch</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">hashCode</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">83766130</span><span class="o">:</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="s">&quot;World&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">var2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">99162322</span><span class="o">:</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">var2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">113318802</span><span class="o">:</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">var2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span><span class="p">(</span><span class="n">var2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span><span class='line'>        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>        <span class="p">(</span><span class="k">new</span> <span class="n">Throwable</span><span class="p">()).</span><span class="n">printStackTrace</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>lambda</h2>

<p>源代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">stop</span><span class="p">).</span><span class="n">setOnClickListener</span><span class="p">((</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//Yes! use &quot;this&quot; to refer to the MainActivity.this</span>
</span><span class='line'>    <span class="n">Toast</span><span class="p">.</span><span class="n">makeText</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">&quot;Hello lambda&quot;</span><span class="p">,</span> <span class="n">Toast</span><span class="p">.</span><span class="n">LENGTH_SHORT</span><span class="p">).</span><span class="n">show</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;crash in lambda&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">Throwable</span><span class="p">().</span><span class="n">printStackTrace</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>class反编译：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">this</span><span class="p">.</span><span class="n">findViewById</span><span class="p">(</span><span class="mi">2131492943</span><span class="p">).</span><span class="n">setOnClickListener</span><span class="p">(</span><span class="n">MainActivity</span><span class="err">$$</span><span class="n">Lambda</span><span class="err">$</span><span class="mf">1.</span><span class="n">lambdaFactory</span><span class="err">$</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
</span><span class='line'><span class="k">final</span> <span class="k">class</span> <span class="nc">MainActivity</span><span class="err">$$</span><span class="n">Lambda</span><span class="err">$</span><span class="mi">1</span> <span class="n">implements</span> <span class="n">OnClickListener</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">final</span> <span class="n">MainActivity</span> <span class="n">arg</span><span class="err">$</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">MainActivity</span><span class="err">$$</span><span class="n">Lambda</span><span class="err">$</span><span class="mi">1</span><span class="p">(</span><span class="n">MainActivity</span> <span class="n">var1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">arg</span><span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="n">var1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">OnClickListener</span> <span class="n">get</span><span class="err">$</span><span class="n">Lambda</span><span class="p">(</span><span class="n">MainActivity</span> <span class="n">var0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">MainActivity</span><span class="err">$$</span><span class="n">Lambda</span><span class="err">$</span><span class="mi">1</span><span class="p">(</span><span class="n">var0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">void</span> <span class="n">onClick</span><span class="p">(</span><span class="n">View</span> <span class="n">var1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">MainActivity</span><span class="p">.</span><span class="n">access</span><span class="err">$</span><span class="n">lambda</span><span class="err">$</span><span class="mi">0</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">arg</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="n">var1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">OnClickListener</span> <span class="n">lambdaFactory</span><span class="err">$</span><span class="p">(</span><span class="n">MainActivity</span> <span class="n">var0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">MainActivity</span><span class="err">$$</span><span class="n">Lambda</span><span class="err">$</span><span class="mi">1</span><span class="p">(</span><span class="n">var0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到生成的class中两个工厂方法get$Lambda和lambdaFactory$其实除了名字其他都一样，而且代码中只调用了后者，因此proguard混淆之后，会删除get$Lambda方法。这样和之前的InnerClass比起来就只是多了LambdaFactory$一个工厂方法。然而lambda的实现中会在MainActivity中添加一个 MainActivity.access$lambda$0 ，然后该方法会调用 MainActivity.lambda$onCreate$0 方法（这个命名和java8的lambda是一致的）。然而这里其实没必要使用access方法，因为lambda方法（即上文的MainActivity.lambda$onCreate$0 ）是编译器生成的，不会被其他方法引用。（嗯！java8就没有access方法！），不过没关系retrolambda是开源的，不爽可以自己改（就是这么任性！）。</p>

<p>优：</p>

<ol>
<li>把InnerClass改成了外部static class。避免了this$0逸出。</li>
</ol>


<p>劣：</p>

<pre><code>1. 所以总体方法数多了两个。可以改成只多一个。
2. lambda内部的堆栈dump会多几层，但是最后还是会定位到lambda内部。
</code></pre>

<p>下面是lambda内部crash堆栈dump：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>08-14 09:30:46.402  11348-11348/young.com.demo I/System.out﹕ crash in lambda
</span><span class='line'>08-14 09:30:46.402  11348-11348/young.com.demo W/System.err﹕ java.lang.Throwable
</span><span class='line'>08-14 09:30:46.402  11348-11348/young.com.demo W/System.err﹕ at young.com.demo.MainActivity.lambda<span class="nv">$onCreate$0</span><span class="o">(</span>MainActivity.java:81<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.402  11348-11348/young.com.demo W/System.err﹕ at young.com.demo.MainActivity.access<span class="nv">$lambda$0</span><span class="o">(</span>MainActivity.java<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.402  11348-11348/young.com.demo W/System.err﹕ at young.com.demo.MainActivity<span class="nv">$$</span>Lambda<span class="nv">$1</span>.onClick<span class="o">(</span>Unknown Source<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.402  11348-11348/young.com.demo W/System.err﹕ at android.view.View.performClick<span class="o">(</span>View.java:4781<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.402  11348-11348/young.com.demo W/System.err﹕ at android.view.View<span class="nv">$PerformClick</span>.run<span class="o">(</span>View.java:19873<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.402  11348-11348/young.com.demo W/System.err﹕ at android.os.Handler.handleCallback<span class="o">(</span>Handler.java:739<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.403  11348-11348/young.com.demo W/System.err﹕ at android.os.Handler.dispatchMessage<span class="o">(</span>Handler.java:95<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.403  11348-11348/young.com.demo W/System.err﹕ at android.os.Looper.loop<span class="o">(</span>Looper.java:135<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.403  11348-11348/young.com.demo W/System.err﹕ at android.app.ActivityThread.main<span class="o">(</span>ActivityThread.java:5289<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.403  11348-11348/young.com.demo W/System.err﹕ at java.lang.reflect.Method.invoke<span class="o">(</span>Native Method<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.403  11348-11348/young.com.demo W/System.err﹕ at java.lang.reflect.Method.invoke<span class="o">(</span>Method.java:372<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.403  11348-11348/young.com.demo W/System.err﹕ at com.android.internal.os.ZygoteInit<span class="nv">$MethodAndArgsCaller</span>.run<span class="o">(</span>ZygoteInit.java:904<span class="o">)</span>
</span><span class='line'>08-14 09:30:46.403  11348-11348/young.com.demo W/System.err﹕ at com.android.internal.os.ZygoteInit.main<span class="o">(</span>ZygoteInit.java:699<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Lambda Method Reference：</h2>

<p>源代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">private</span> <span class="n">interface</span> <span class="n">StringConsumer</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">consumeAString</span><span class="p">(</span><span class="n">String</span> <span class="n">str</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">testMethodReference</span><span class="p">(</span><span class="n">StringConsumer</span> <span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">sc</span><span class="p">.</span><span class="n">consumeAString</span><span class="p">(</span><span class="s">&quot;testStringConsumer&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">testMethodReference</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="o">::</span><span class="n">println</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>class反编译：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">testMethodReference</span><span class="p">(</span><span class="n">MainActivity</span><span class="err">$$</span><span class="n">Lambda</span><span class="err">$</span><span class="mf">4.</span><span class="n">lambdaFactory</span><span class="err">$</span><span class="p">(</span><span class="n">var10000</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="k">final</span> <span class="k">class</span> <span class="nc">MainActivity</span><span class="err">$$</span><span class="n">Lambda</span><span class="err">$</span><span class="mi">4</span> <span class="n">implements</span> <span class="n">StringConsumer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">final</span> <span class="n">PrintStream</span> <span class="n">arg</span><span class="err">$</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">MainActivity</span><span class="err">$$</span><span class="n">Lambda</span><span class="err">$</span><span class="mi">4</span><span class="p">(</span><span class="n">PrintStream</span> <span class="n">var1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">arg</span><span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="n">var1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">StringConsumer</span> <span class="n">get</span><span class="err">$</span><span class="n">Lambda</span><span class="p">(</span><span class="n">PrintStream</span> <span class="n">var0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">MainActivity</span><span class="err">$$</span><span class="n">Lambda</span><span class="err">$</span><span class="mi">4</span><span class="p">(</span><span class="n">var0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">void</span> <span class="n">consumeAString</span><span class="p">(</span><span class="n">String</span> <span class="n">var1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">arg</span><span class="err">$</span><span class="mf">1.</span><span class="n">println</span><span class="p">(</span><span class="n">var1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">StringConsumer</span> <span class="n">lambdaFactory</span><span class="err">$</span><span class="p">(</span><span class="n">PrintStream</span> <span class="n">var0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">MainActivity</span><span class="err">$$</span><span class="n">Lambda</span><span class="err">$</span><span class="mi">4</span><span class="p">(</span><span class="n">var0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>MultiCatch</h2>

<p>源代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">testMultiCatch</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;testMultiCatch&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="p">();</span>
</span><span class='line'>            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">();</span>
</span><span class='line'>            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="p">();</span>
</span><span class='line'>            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">NullPointerException</span> <span class="o">|</span> <span class="n">IllegalStateException</span> <span class="o">|</span> <span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">RuntimeException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//make this branch different to suppress warnings</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">hashCode</span><span class="p">();</span>
</span><span class='line'>        <span class="n">ex</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>class反编译：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">testMultiCatch</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;testMultiCatch&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">switch</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="p">();</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">();</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="p">();</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IllegalStateException</span> <span class="o">|</span> <span class="n">IOException</span> <span class="o">|</span> <span class="n">NullPointerException</span> <span class="n">var3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">var3</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">RuntimeException</span> <span class="n">var4</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">var4</span><span class="p">.</span><span class="n">hashCode</span><span class="p">();</span>
</span><span class='line'>        <span class="n">var4</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>好像没什么区别，不是我粘错了，估计是JVM本来就支持这个特性。
</code></pre>

<h2>tryWithResource</h2>

<p>源代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">testTryWithResource</span><span class="p">(</span><span class="n">ServerSocket</span> <span class="n">ss</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">ss</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">try</span> <span class="p">(</span><span class="n">Socket</span> <span class="n">in</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">accept</span><span class="p">();</span>
</span><span class='line'>     <span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">in</span><span class="p">.</span><span class="n">getInputStream</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">is</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>class反编译：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">testTryWithResource</span><span class="p">(</span><span class="n">ServerSocket</span> <span class="n">ss</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">ss</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">try</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Socket</span> <span class="n">in</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">accept</span><span class="p">();</span>
</span><span class='line'>            <span class="n">Throwable</span> <span class="n">var2</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">try</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">in</span><span class="p">.</span><span class="n">getInputStream</span><span class="p">();</span>
</span><span class='line'>                <span class="n">Throwable</span> <span class="n">var4</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">try</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">is</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">var29</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">var4</span> <span class="o">=</span> <span class="n">var29</span><span class="p">;</span>
</span><span class='line'>                    <span class="k">throw</span> <span class="n">var29</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="n">finally</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span><span class="p">(</span><span class="n">is</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">if</span><span class="p">(</span><span class="n">var4</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="n">try</span> <span class="p">{</span>
</span><span class='line'>                                <span class="n">is</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span><span class='line'>                            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">var28</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                <span class="p">;</span>
</span><span class='line'>                            <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                            <span class="n">is</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">var31</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">var2</span> <span class="o">=</span> <span class="n">var31</span><span class="p">;</span>
</span><span class='line'>                <span class="k">throw</span> <span class="n">var31</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="n">finally</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span><span class="p">(</span><span class="n">in</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span><span class="p">(</span><span class="n">var2</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">try</span> <span class="p">{</span>
</span><span class='line'>                            <span class="n">in</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span><span class='line'>                        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Throwable</span> <span class="n">var27</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="p">;</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">in</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">var33</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>好™啰嗦啦！绝对不要用这个。</p>

<p>附录
关于androidBuildTool对java7的支持，原文来自：</p>

<p><a href="">http://tools.android.com/tech-docs/new-build-system/user-guide#TOC-Using-sourceCompatibility-1.7</a></p>

<p>Using sourceCompatibility 1.7
With Android KitKat (buildToolsVersion 19) you can use the diamond operator, multi-catch, strings in switches, try with resources, etc. To do this, add the following to your build file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">android</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">compileSdkVersion</span> <span class="mi">19</span>
</span><span class='line'>    <span class="n">buildToolsVersion</span> <span class="s">&quot;19.0.0&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">defaultConfig</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">minSdkVersion</span> <span class="mi">7</span>
</span><span class='line'>        <span class="n">targetSdkVersion</span> <span class="mi">19</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">compileOptions</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">sourceCompatibility</span> <span class="n">JavaVersion</span><span class="p">.</span><span class="n">VERSION_1_7</span>
</span><span class='line'>        <span class="n">targetCompatibility</span> <span class="n">JavaVersion</span><span class="p">.</span><span class="n">VERSION_1_7</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that you can use minSdkVersion with a value earlier than 19, for all language features <em>except try with resources</em>. If you want to use try with resources, you will need to also use a minSdkVersion of 19.</p>

<p>You also need to make sure that Gradle is using version 1.7 or later of the JDK. (And version 0.6.1 or later of the Android Gradle plugin.)</p>

<h1>匿名类 VS Lambda</h1>

<p>今天修复了几个listener导致内存泄露的问题。
在review代码的过程中发现很多泄露是匿名类的this$0导致的，事实上挺多时候匿名类并没有显式的使用到this。</p>

<h2>匿名类</h2>

<p><strong>匿名类必然会引用this，不管代码中是否真正用到。</strong>
java中的匿名类和非static内部类（标准叫法是嵌套类nested class，内部类专指static inner class），都会有外部类的引用，通过构造函数传进来，并在内部类的this$0成员变量中保存；但是我们通常不会注意到他们，因为java编译器帮我们做了这些；如果我们查看反编译的class文件会发现他们是真真切切的存在。</p>

<p>比如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">private</span> <span class="n">BroadcastReceiver</span> <span class="n">mCollectionReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BroadcastReceiver</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="err">@</span><span class="n">Override</span>
</span><span class='line'>        <span class="k">public</span> <span class="kt">void</span> <span class="n">onReceive</span><span class="p">(</span><span class="n">Context</span> <span class="n">context</span><span class="p">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">//...</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>反编译javac生成的class</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">BroadcastDetailFragment</span><span class="err">$</span><span class="mi">4</span>
</span><span class='line'>  <span class="n">extends</span> <span class="n">BroadcastReceiver</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">BroadcastDetailFragment</span><span class="err">$</span><span class="mi">4</span><span class="p">(</span><span class="n">BroadcastDetailFragment</span> <span class="k">this</span><span class="err">$</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">void</span> <span class="n">onReceive</span><span class="p">(</span><span class="n">Context</span> <span class="n">context</span><span class="p">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">//...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到构造函数中是有个this$0的参数的。</p>

<h2>Lambda</h2>

<p><strong>lambda不一定会引用this，具体看lambda里面是否用到。</strong>
Lambda中所有引用到的外部的变量都是通过参数的形式传给实现lambda的函数的。如果lambda中用到this或非static成员方法、非static成员变量，那么lambda就必须引用this，这个this就是作为参数传给实现lambda的函数；反之，若lambda不需要this，编译器就不会传this作为参数，这时候该lambda生成的类就不会泄露我们的Fragment，Activity。</p>

<h2>总结：</h2>

<p>使用Lambda除了可以使代码更优雅，还可以减少不必要的this泄露。
之前我曾担心过：retro-lambda会给每个lambda生成一个类，会不会带来性能，内存之类的压力；但是想到scala语言就是用这种方式实现的lambda，而且玩的很欢乐，想必不用过度担心。</p>

<h3>附录：</h3>

<ol>
<li><p>关于scala和java8是怎么分别实现lambda的，可以参看<a href="http://blog.takipi.com/compiling-lambda-expressions-scala-vs-java-8/">这篇文章</a>。PS：retro-lambda是模仿了scala的做法（因为android中不支持invokedynamic虚拟机指令，其在java7中引入，所以理论上javac生成的lambda在java7上也是能跑的）</p></li>
<li><p>retrolambda测试报告，在项目引入retro-lambda之前，我做了几个实验，验证之前的疑问点。下面是之前的结论，再贴一遍~方便翻阅~</p></li>
</ol>

</div>

</article>

	

<!--aThis Button BEGIN -->
<div class="jiathis_style">
	<span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tools_1"></a>
	<a class="jiathis_button_tools_2"></a>
	<a class="jiathis_button_tools_3"></a>
	<a class="jiathis_button_tools_4"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner">
<p>
  Copyright &copy; 2016 - LanderlYoung -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>

<!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'landerlyoung';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://LanderlYoung.github.io/blog/2016/01/11/re-lambda-ce-shi-bao-gao/';
        var disqus_url = 'http://LanderlYoung.github.io/blog/2016/01/11/re-lambda-ce-shi-bao-gao/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







		</div>
	</div>

	<div id="slide">
		<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/11/re-lambda-ce-shi-bao-gao/">Retro-lambda 测试报告</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/09/ijkplyer-bian-yi-pei-zhi/">Ijkplyer 编译配置</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/04/javaxu-lie-hua-shi-jian/">Java序列化实践</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/09/androidzhong-servicede-shi-yong/">Android中service的使用</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/31/androidzhong-de-wakelockshi-yong/">Android中的WakeLock使用</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/android/'>android (9)</a></li><li><a href='/blog/categories/git/'>git (2)</a></li><li><a href='/blog/categories/html5/'>html5 (5)</a></li><li><a href='/blog/categories/java/'>java (4)</a></li><li><a href='/blog/categories/javascript/'>javascript (3)</a></li><li><a href='/blog/categories/linux/'>linux (7)</a></li></ul>
</section>
<section>
	<h1>Tags</h1>
	<ul class="tag-cloud">
		<li><a style="font-size: 117.3%" href="/tags/android/">Android</a></li>
<li><a style="font-size: 113.5%" href="/tags/linux/">Linux</a></li>
<li><a style="font-size: 70.1%" href="/tags/html5/">HTML5</a></li>
<li><a style="font-size: 103.3%" href="/tags/java/">Java</a></li>
<li><a style="font-size: 118.8%" href="/tags/node-dot-js/">Node.js</a></li>
<li><a style="font-size: 105.5%" href="/tags/dictonary-node-dot-js/">dictonary_Node.js</a></li>
<li><a style="font-size: 78.9%" href="/tags/java/">java</a></li>
<li><a style="font-size: 103.2%" href="/tags/android/">android</a></li>
<li><a style="font-size: 117.7%" href="/tags/git/">Git</a></li>
<li><a style="font-size: 99.8%" href="/tags/vim/">Vim</a></li>
<li><a style="font-size: 94.3%" href="/tags/androidyuan-dai-ma/">Android源代码</a></li>
<li><a style="font-size: 113.4%" href="/tags/sou-gou-shu-ru-fa/">搜狗输入法</a></li>
<li><a style="font-size: 106.9%" href="/tags/octpressban-qian-bian-ji-wei-zhi/">Octpress搬迁编辑位置</a></li>
<li><a style="font-size: 109.3%" href="/tags/tencent/">tencent</a></li>
<li><a style="font-size: 110.8%" href="/tags/zhuan-tie/">转贴</a></li>
<li><a style="font-size: 92.9%" href="/tags/sensor/">sensor</a></li>
<li><a style="font-size: 110.0%" href="/tags/ui/">UI</a></li>
<li><a style="font-size: 92.9%" href="/tags/svg/">SVG</a></li>
<li><a style="font-size: 75.5%" href="/tags/intellij/">IntelliJ</a></li>
<li><a style="font-size: 111.0%" href="/tags/jni/">JNI</a></li>

	</ul>
</section>

	</div>
	<div id="hint">&gt;</div>

	<div id="drawer">
		<div id="touch"></div>
		<div id="bar">
			<div class="info">
				<ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about-me/">About Me</a></li>
</ul>

			</div>
		</div>
	</div>
	<script src="/javascripts/slide.js"></script>

</body>
</html>
